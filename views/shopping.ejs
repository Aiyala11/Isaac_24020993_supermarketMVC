<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="/css/style.css" rel="stylesheet">
  <title>Shopping - Isaac's Supermarket</title>
  <style>
    body {
      background: linear-gradient(135deg, #f0f7f2 0%, #f8fbf9 100%);
    }
  </style>
</head>

<body>

  <!-- INCLUDE NAV -->
  <%- include('partials/usernavbar') %>

  <div class="container mt-5">
    <h1><i class="bi bi-bag-fill"></i> Shopping</h1>
    <p>Welcome, <strong><%= user.username %></strong>!</p>

    <!-- Search Bar -->
    <div class="mb-4">
      <input 
        type="text" 
        id="productSearch" 
        class="form-control" 
        placeholder="Search products..."
      >
    </div>

    <!-- Category Filter -->
    <div class="mb-4">
      <button class="btn btn-outline-success me-2 category-btn active" data-category="all">All Products</button>
      <% if (typeof categories !== "undefined" && categories && categories.length > 0) { %>
        <% categories.forEach(c => { %>
          <button class="btn btn-outline-success me-2 category-btn" data-category="<%= c.id %>">
            <%= c.name %>
          </button>
        <% }) %>
      <% } %>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="alert alert-danger" style="display: none;">
      No products found.
    </div>

    <!-- Products Grid -->
    <div class="row g-4" id="productList">
      <% products.forEach(p => { %>
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 product-item" data-category="<%= p.categoryId %>">
          <div class="card h-100 <%= p.quantity === 0 ? 'opacity-50' : '' %>">
            
            <!-- Product Image -->
            <img src="/images/<%= p.image || 'default.png' %>" class="card-img-top" alt="<%= p.productName %>" onerror="this.src='/images/default.png'" style="height: 150px; object-fit: contain; background: #f0f7f2; padding: 10px;">

            <div class="card-body">
              <!-- Product Name -->
              <h5 class="card-title">
                <a href="/product/<%= p.id %>" class="text-decoration-none">
                  <%= p.productName %>
                </a>
              </h5>

              <!-- Category -->
              <p class="card-text small text-muted">
                <i class="bi bi-tag"></i> <%= p.categoryName || 'Grocery' %>
              </p>

              <!-- Price -->
              <h4 class="text-success fw-bold">$<%= Number(p.price).toFixed(2) %></h4>

              <!-- Stock Status -->
              <p class="card-text small <%= p.quantity === 0 ? 'text-danger fw-bold' : (p.quantity <= 20 ? 'text-warning fw-bold' : 'text-success fw-bold') %>">
                <%= p.quantity === 0 ? 'Out of Stock' : (p.quantity <= 20 ? `Only ${p.quantity} left!` : 'In Stock') %>
              </p>

              <% if (p.quantity > 0) { %>
                <!-- Quantity Control -->
                <div class="input-group mb-3">
                  <button type="button" class="btn btn-outline-secondary qty-btn-minus" data-id="<%= p.id %>" data-delta="-1"></button>
                  <input type="text" id="qty-<%= p.id %>" class="form-control text-center qty-input" value="1" readonly>
                  <button type="button" class="btn btn-outline-secondary qty-btn-plus" data-id="<%= p.id %>" data-delta="1" data-max="<%= p.quantity %>">+</button>
                </div>

                <!-- Add to Cart Form (Hidden) -->
                <form action="/add-to-cart/<%= p.id %>" method="POST" id="form-<%= p.id %>" style="display: none;">
                  <input type="hidden" name="quantity" id="hidden-qty-<%= p.id %>" value="1">
                </form>

                <!-- Add to Cart Button -->
                <button type="button" class="btn btn-success w-100" onclick="submitAddToCart(<%= p.id %>)">
                  <i class="bi bi-plus-circle"></i> Add to Cart
                </button>
              <% } else { %>
                <button class="btn btn-secondary w-100" disabled>
                  <i class="bi bi-lock"></i> Unavailable
                </button>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- Toast for stock warning -->
  <div id="stockToast" class="alert alert-danger position-fixed bottom-0 end-0 m-3" style="display: none; z-index: 9999;">
    You cannot add more than available stock!
  </div>

  <script>
    /* SUBMIT ADD TO CART FORM */
    function submitAddToCart(productId) {
      const qty = document.getElementById("qty-" + productId).value;
      document.getElementById("hidden-qty-" + productId).value = qty;
      document.getElementById("form-" + productId).submit();
    }

    /* QUANTITY BUTTONS - PLUS/MINUS */
    document.addEventListener("click", e => {
      if (e.target.classList.contains("qty-btn-minus") || e.target.classList.contains("qty-btn-plus")) {
        e.preventDefault();
        e.stopPropagation();

        const id = e.target.dataset.id;
        const delta = parseInt(e.target.dataset.delta);
        const max = parseInt(e.target.dataset.max);
        const input = document.getElementById("qty-" + id);

        if (!input) return;

        let qty = parseInt(input.value) || 1;
        qty += delta;

        if (qty < 1) qty = 1;
        if (!isNaN(max) && qty > max) {
          qty = max;
          const toast = document.getElementById("stockToast");
          toast.style.display = "block";
          setTimeout(() => toast.style.display = "none", 2500);
          return;
        }

        input.value = qty;
      }
    });

    /* CATEGORY FILTER - BUTTONS */
    document.querySelectorAll(".category-btn").forEach(btn => {
      btn.addEventListener("click", function() {
        document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        filterProducts();
      });
    });

    /* SEARCH INPUT */
    const searchInput = document.getElementById("productSearch");
    if (searchInput) {
      searchInput.addEventListener("input", filterProducts);
    }

    /* FILTER FUNCTION */
    function filterProducts() {
      const searchValue = document.getElementById("productSearch").value.trim().toLowerCase();
      const activeBtn = document.querySelector(".category-btn.active");
      const activeCategory = activeBtn ? activeBtn.dataset.category : "all";

      let visibleCount = 0;

      document.querySelectorAll(".product-item").forEach(item => {
        const nameElement = item.querySelector(".card-title a");
        if (!nameElement) return;

        const nameText = nameElement.textContent.trim();
        const nameLower = nameText.toLowerCase();
        const itemCategory = item.dataset.category;

        // Check category match
        const categoryMatch = activeCategory === "all" || itemCategory === activeCategory;

        // Check search match
        const searchMatch = searchValue === "" || nameLower.includes(searchValue);

        // Determine visibility
        const isVisible = categoryMatch && searchMatch;

        if (isVisible) {
          item.classList.remove("d-none");
          visibleCount++;
        } else {
          item.classList.add("d-none");
        }
      });

      // Show/hide no results message
      const noResults = document.getElementById("noResults");
      if (noResults) {
        noResults.style.display = visibleCount === 0 ? "block" : "none";
      }
    }
  </script>

</body>
</html>

<!-- Include Chatbot Widget -->
<%- include('partials/chatbot') %>
