<!DOCTYPE html>
<html>
<head>
    <title>Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Supermarket App</a>
        <a href="/cart" class="nav-link text-white">Back to Cart</a>
    </div>
</nav>

<div class="container mt-4">

    <h2>Payment</h2>
    <hr>

    <div class="row">
        <!-- ADDRESS BOX -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><strong>Delivery Address</strong></span>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="edit-address-btn">
                        Edit
                    </button>
                </div>
                <div class="card-body">
                    <p id="address-text">
                        <% if (user.address) { %>
                            <%= user.address %>
                        <% } else { %>
                            <em>No address saved yet.</em>
                        <% } %>
                    </p>

                    <!-- Edit form (hidden by default) -->
                    <form id="address-form" action="/update-address" method="POST" class="d-none">
                        <div class="mb-2">
                            <label class="form-label">Address</label>
                            <input type="text" name="address" class="form-control"
                                   value="<%= user.address || '' %>" required>
                        </div>

                        <!-- Keep selected items after reload -->
                        <input type="hidden" name="selectedItems" value="<%= selectedItemsRaw || '' %>">

                        <button class="btn btn-sm btn-success">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary" id="cancel-edit-address">
                            Cancel
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ORDER SUMMARY -->
        <div class="col-md-8">
            <h4>Order Summary</h4>

            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50%">Product</th>
                        <th style="width:15%">Quantity</th>
                        <th style="width:20%">Amount</th>
                    </tr>
                </thead>

                <tbody>
                    <% items.forEach(item => { %>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="/images/<%= item.image %>"
                                         class="me-3 rounded"
                                         style="
                                            width: 80px;
                                            height: 80px;
                                            object-fit: contain;
                                            background: white;
                                            border: 1px solid #ddd;
                                            padding: 5px;
                                         ">
                                    <div>
                                        <strong><%= item.productName %></strong>
                                    </div>
                                </div>
                            </td>

                            <td><%= item.quantity %></td>

                            <td>$<%= (Number(item.price) * item.quantity).toFixed(2) %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>

            <h4 class="mt-3">Total: $<%= total.toFixed(2) %></h4>
        </div>
    </div>

    <!-- PAYMENT FORM -->
    <form action="/payment" method="POST" class="mt-4" id="payment-form">
        <!-- selected cart_items IDs -->
        <input type="hidden" name="selectedItems" value="<%= selectedItemsRaw || '' %>">
        <!-- Hidden inputs for currency and BNPL (populated on submit) -->
        <input type="hidden" id="hidden-currency" name="displayCurrency" value="SGD">
        <input type="hidden" id="hidden-bnpl" name="bnplMonths" value="">

        <!-- Currency Selection -->
        <div class="mb-3">
            <label class="form-label">Currency</label>
            <select id="currency" class="form-select mb-3">
                <option value="SGD" selected>SGD (Singapore Dollar)</option>
                <option value="USD">USD (US Dollar)</option>
                <option value="MYR">MYR (Malaysian Ringgit)</option>
            </select>
        </div>

        <!-- BNPL Selection -->
        <div class="mb-3">
            <label class="form-label">Payment Plan (Optional)</label>
            <select id="bnpl-months" class="form-select mb-3">
                <option value="">Pay Now</option>
                <option value="3">3 Months Installment</option>
                <option value="6">6 Months Installment</option>
                <option value="12">12 Months Installment</option>
            </select>
        </div>

        <label class="form-label">Payment Method</label>
        <select name="paymentMethod" id="payment-method" class="form-select mb-3" required>
            <option value="">Select...</option>
            <option value="Credit Card">Credit Card</option>
            <option value="PayNow">PayNow</option>
            <option value="NETS QR">NETS QR (Bank Transfer)</option>
            <option value="Stripe">Stripe (Card)</option>
            <option value="PayPal">PayPal</option>
        </select>

        <!-- CREDIT CARD -->
        <div id="credit-card-section" class="mb-3 d-none">
            <label class="form-label">Credit Card Number</label>
            <input type="text"
                   class="form-control"
                   id="card-number"
                   name="cardNumber"
                   maxlength="19"
                   value="1234 5678 9123 4567">
            <div class="form-text">16 digits required.</div>
        </div>

        <!-- PAYNOW -->
        <div id="paynow-section" class="mb-3 d-none text-center">
            <p>Scan this PayNow QR to pay:</p>
            <!-- Add your own file here â†’ public/images/paynowqr.png -->
            <img src="/images/paynowqr.png" alt="PayNow QR Code" style="max-width: 220px;">
        </div>

        <!-- NETS QR -->
        <div id="nets-section" class="mb-3 d-none">
            <div class="alert alert-info">
                <strong>ðŸ’³ NETS QR Payment</strong>
                <p>Scan the QR code with your bank app to complete the payment. You will be directed to the payment screen after clicking "Confirm & Pay".</p>
            </div>
        </div>

        <button class="btn btn-success w-100 btn-lg" type="submit" id="pay-button">Confirm & Pay</button>
        <div id="loading-spinner" class="d-none text-center mt-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating QR Code...</p>
        </div>
    </form>

</div>

<script>
  // Payment method UI
  const paymentMethodSelect = document.getElementById("payment-method");
  const creditCardSection   = document.getElementById("credit-card-section");
  const paynowSection       = document.getElementById("paynow-section");
  const netsSection         = document.getElementById("nets-section");
  const cardInput           = document.getElementById("card-number");
  const paymentForm         = document.getElementById("payment-form");
  const payButton           = document.getElementById("pay-button");
  const loadingSpinner      = document.getElementById("loading-spinner");
  const currencySelect      = document.getElementById("currency");
  const bnplSelect          = document.getElementById("bnpl-months");

  function updatePaymentUI() {
      const method = paymentMethodSelect.value;
      creditCardSection.classList.add("d-none");
      paynowSection.classList.add("d-none");
      netsSection.classList.add("d-none");

      if (method === "Credit Card") {
          creditCardSection.classList.remove("d-none");
      } else if (method === "PayNow") {
          paynowSection.classList.remove("d-none");
      } else if (method === "NETS QR") {
          netsSection.classList.remove("d-none");
      }
  }

  paymentMethodSelect.addEventListener("change", updatePaymentUI);
  document.addEventListener("DOMContentLoaded", updatePaymentUI);

  // Handle form submission
  paymentForm.addEventListener("submit", function (e) {
      e.preventDefault();
      
      const method = paymentMethodSelect.value;
      const total = <%= total %>;
      const currency = currencySelect.value;
      const bnplMonths = bnplSelect.value;

      // Add hidden inputs for currency and BNPL before submitting regular payments
      function addHiddenInputs() {
          let existingCurrency = document.querySelector('input[name="displayCurrency"]');
          let existingBNPL = document.querySelector('input[name="bnplMonths"]');
          
          if (!existingCurrency) {
              let input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'displayCurrency';
              input.value = currency;
              paymentForm.appendChild(input);
          } else {
              existingCurrency.value = currency;
          }
          
          if (!existingBNPL) {
              let input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'bnplMonths';
              input.value = bnplMonths || '';
              paymentForm.appendChild(input);
          } else {
              existingBNPL.value = bnplMonths || '';
          }
      }

      // Validate credit card
      if (method === "Credit Card") {
          const digits = (cardInput.value || "").replace(/\D/g, "");
          if (digits.length !== 16) {
              alert("Credit card number must have exactly 16 digits.");
              return;
          }
          // Submit form normally for credit card
          addHiddenInputs();
          paymentForm.method = "POST";
          paymentForm.action = "/payment";
          paymentForm.submit();
      } else if (method === "NETS QR") {
          handleNETSPayment();
      } else if (method === "PayNow") {
          // Submit form normally for PayNow
          addHiddenInputs();
          paymentForm.method = "POST";
          paymentForm.action = "/payment";
          paymentForm.submit();
      } else if (method === "Stripe") {
          handleStripePayment(total, currency, bnplMonths);
      } else if (method === "PayPal") {
          handlePayPalPayment(total, currency, bnplMonths);
      }
  });

  function handleNETSPayment() {
      const total = <%= total %>;
      
      payButton.disabled = true;
      loadingSpinner.classList.remove("d-none");
      loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Generating QR Code...</p>';

      fetch("/generateNETSQR", {
          method: "POST",
          headers: {
              "Content-Type": "application/json"
          },
          body: JSON.stringify({ cartTotal: total })
      })
      .then(response => response.text())
      .then(html => {
          document.documentElement.innerHTML = html;
      })
      .catch(error => {
          console.error("Error:", error);
          alert("Failed to generate NETS QR code. Please try again.");
          payButton.disabled = false;
          loadingSpinner.classList.add("d-none");
      });
  }

  function handleStripePayment(total, currency, bnplMonths) {
      payButton.disabled = true;
      loadingSpinner.classList.remove("d-none");
      loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Redirecting to Stripe...</p>';

      fetch("/create-stripe-checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
              cartTotal: total,
              currency: currency,
              bnplMonths: bnplMonths
          })
      })
      .then(response => {
          if (response.status === 302 || response.type === 'opaqueredirect') {
              // Redirect response
              window.location.href = response.url || response.headers.get('location');
          } else {
              return response.text().then(text => {
                  window.location.href = text;
              });
          }
      })
      .catch(error => {
          console.error("Stripe error:", error);
          alert("Stripe payment failed. Please try again.");
          payButton.disabled = false;
          loadingSpinner.classList.add("d-none");
      });
  }

  function handlePayPalPayment(total, currency, bnplMonths) {
      payButton.disabled = true;
      loadingSpinner.classList.remove("d-none");
      loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Redirecting to PayPal...</p>';

      fetch("/create-paypal-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
              cartTotal: total,
              currency: currency,
              bnplMonths: bnplMonths
          })
      })
      .then(response => response.json())
      .then(data => {
          window.location.href = data.redirectUrl;
      })
      .catch(error => {
          console.error("PayPal error:", error);
          alert("PayPal payment failed. Please try again.");
          payButton.disabled = false;
          loadingSpinner.classList.add("d-none");
      });
  }

  // Address editing
  const editBtn     = document.getElementById("edit-address-btn");
  const addressForm = document.getElementById("address-form");
  const addressText = document.getElementById("address-text");
  const cancelEdit  = document.getElementById("cancel-edit-address");

  if (editBtn) {
      editBtn.addEventListener("click", () => {
          addressForm.classList.remove("d-none");
          addressText.classList.add("d-none");
      });
  }

  if (cancelEdit) {
      cancelEdit.addEventListener("click", () => {
          addressForm.classList.add("d-none");
          addressText.classList.remove("d-none");
      });
  }
</script>

</body>
</html>
