<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isaac's Supermarket - Fresh Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="/css/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@500;600&display=swap" rel="stylesheet">
  <style>
    body { background: #f6fbf6; font-family: 'Sora','Inter','Segoe UI',sans-serif; }
    .hero { background: linear-gradient(135deg, #e8f5eb 0%, #f1f8f4 100%); border-radius: 24px; padding: 42px 40px; position: relative; overflow: hidden; }
    .hero h1 { font-size: clamp(32px, 5vw, 44px); line-height: 1.1; }
    .hero p { max-width: 520px; color: #2d4737; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 999px; background: #e2f6e8; color: #0f5132; font-weight: 700; letter-spacing: 0.4px; }
    .pill i { color: #1aa34a; }
    .cta-btn { border-radius: 12px; padding: 12px 18px; font-weight: 700; }
    .card-feature { border: none; border-radius: 18px; box-shadow: 0 18px 40px rgba(0,0,0,0.08); overflow: hidden; background: #fff; }
    .card-feature img { height: 180px; object-fit: contain; background: #f3f8f2; }
    .category-chip { border: 1px solid #d7eadb; background: #fff; border-radius: 999px; padding: 10px 14px; font-weight: 600; color: #0f5132; cursor: pointer; transition: all 0.2s ease; }
    .category-chip.active, .category-chip:hover { background: #0f5132; color: #fff; border-color: #0f5132; box-shadow: 0 8px 20px rgba(15,81,50,0.25); }
    .stat-card { background: #fff; border-radius: 14px; padding: 14px 16px; box-shadow: 0 8px 22px rgba(0,0,0,0.08); }
    .section-title { font-weight: 700; color: #163829; }
    .badge-soft { background: #eaf6ec; color: #0f5132; border-radius: 10px; padding: 6px 10px; font-weight: 700; }
    .chip-mini { background: #0f5132; color: #fff; border-radius: 999px; padding: 6px 10px; font-size: 12px; }
    .assistant-toggle { position: fixed; bottom: 20px; right: 20px; z-index: 1060; }
    .chatbox { width: 320px; max-width: 90vw; position: fixed; bottom: 80px; right: 20px; z-index: 1060; border-radius: 16px; box-shadow: 0 18px 40px rgba(0,0,0,0.18); overflow: hidden; display: none; }
    .chatbox-header { background: #0f5132; color: #fff; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; }
    .chat-messages { background: #f7faf7; max-height: 340px; overflow-y: auto; padding: 12px; }
    .chat-bubble { padding: 10px 12px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; }
    .chat-bubble.me { background: #d1f1d8; margin-left: auto; }
    .chat-bubble.bot { background: #fff; border: 1px solid #e7eee6; }
    .search-bar { border-radius: 16px; padding: 14px 18px; border: 1px solid #dce7dd; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .subtle-link { color: #1b743f; font-weight: 700; text-decoration: none; }
    .subtle-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <% if (user && user.role === 'admin') { %>
    <%- include('partials/adminnavbar') %>
  <% } else if (user) { %>
    <%- include('partials/usernavbar') %>
  <% } else { %>
    <%- include('partials/guestnavbar') %>
  <% } %>

  <div class="container my-4">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger"><%= errors.join('<br>') %></div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success"><%= messages.join('<br>') %></div>
    <% } %>

    <section class="hero mb-4 position-relative">
      <div class="row align-items-center gy-4">
        <div class="col-lg-12">
          <div class="pill mb-3">
            <i class="bi bi-lightning-charge-fill"></i> Fresh organic picks, ready today
          </div>
          <h1 class="fw-bold mb-3">Groceries that feel like the farmers' market.</h1>
          <p class="mb-4">Curated quality produce, dairy, and pantry essentials. Delivered fast with real-time order updates.</p>
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-success cta-btn" href="<%= user ? (user.role === 'admin' ? '/inventory' : '/shopping') : '/login' %>">
              <i class="bi bi-basket2-fill"></i> <%= user ? (user.role === 'admin' ? 'Open Dashboard' : 'Start Shopping') : 'Shop now' %>
            </a>
            <% if (user) { %>
              <a class="btn btn-outline-success cta-btn" href="<%= user.role === 'admin' ? '/admin/orders' : '/orders' %>">
                <i class="bi bi-receipt"></i> <%= user.role === 'admin' ? 'Manage orders' : 'Order history' %>
              </a>
            <% } else { %>
              <a class="btn btn-outline-success cta-btn" href="/register"><i class="bi bi-person-plus"></i> Create account</a>
            <% } %>
          </div>
          <div class="d-flex flex-wrap gap-3 mt-4">
            <div class="stat-card">
              <div class="fw-bold text-success"><i class="bi bi-truck"></i> Same-day</div>
              <small class="text-muted">Place orders before 6pm</small>
            </div>
            <div class="stat-card">
              <div class="fw-bold text-success"><i class="bi bi-bag-check"></i> Handpicked</div>
              <small class="text-muted">Quality checked by staff</small>
            </div>
            <div class="stat-card">
              <div class="fw-bold text-success"><i class="bi bi-shield-lock"></i> Secure checkout</div>
              <small class="text-muted">PayNow &amp; cards</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div class="row g-3">
        <div class="col-md-8">
          <div class="input-group search-bar">
            <span class="input-group-text bg-transparent border-0"><i class="bi bi-search text-success"></i></span>
            <input id="homeSearch" type="text" class="form-control border-0" placeholder="Search for fruits, dairy, drinks..." oninput="filterFeatured()">
          </div>
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="d-flex gap-2 flex-wrap" id="categoryChips">
            <button class="category-chip active" data-category="all" onclick="setCategory('all')">All</button>
            <% if (categories && categories.length) { %>
              <% categories.forEach(cat => { %>
                <button class="category-chip" data-category="<%= cat.name %>" onclick="setCategory('<%= cat.name %>')"><%= cat.name %></button>
              <% }) %>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <section id="featured" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <p class="text-success fw-bold mb-1">Top picks this week</p>
          <h3 class="section-title mb-0">Featured products</h3>
        </div>
        <a class="subtle-link" href="<%= user ? (user.role === 'admin' ? '/inventory' : '/shopping') : '/login' %>">
          View full catalog <i class="bi bi-arrow-right"></i>
        </a>
      </div>

      <div class="row g-3" id="featuredGrid">
        <% if (!featuredProducts || featuredProducts.length === 0) { %>
          <div class="col-12">
            <div class="alert alert-info mb-0">No products available yet. Add some in Inventory.</div>
          </div>
        <% } %>

        <% featuredProducts && featuredProducts.forEach(p => { %>
          <div class="col-sm-6 col-lg-3 product-card" data-name="<%= p.productName %>" data-category="<%= p.categoryName || 'Groceries' %>">
            <div class="card card-feature h-100">
              <img src="/images/<%= p.image || 'apples.png' %>" alt="<%= p.productName %>" class="w-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <h6 class="mb-0"><%= p.productName %></h6>
                  <span class="badge-soft"><%= p.categoryName || 'Groceries' %></span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold fs-5 text-success">$<%= Number(p.price || 0).toFixed(2) %></div>
                  <% if (user) { %>
                    <a class="btn btn-sm btn-success" href="<%= user.role === 'admin' ? '/inventory' : '/shopping' %>"><i class="bi bi-plus-circle"></i> Add</a>
                  <% } else { %>
                    <a class="btn btn-sm btn-outline-success" href="/login">Login to buy</a>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </section>

    <section class="mb-4" id="categories">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card h-100 shadow-soft">
            <div class="card-body">
              <div class="chip-mini mb-2"><i class="bi bi-heart-pulse"></i> Freshness</div>
              <h5>Picked and packed carefully</h5>
              <p class="text-muted">We check every item before it goes into your basket.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 shadow-soft">
            <div class="card-body">
              <div class="chip-mini mb-2"><i class="bi bi-clock-history"></i> Speed</div>
              <h5>Same-day slots</h5>
              <p class="text-muted">Place your order before 6pm for doorstep delivery today.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 shadow-soft">
            <div class="card-body">
              <div class="chip-mini mb-2"><i class="bi bi-chat-left-text"></i> Help</div>
              <h5>AI helper on standby</h5>
              <p class="text-muted">Ask questions, find products, and get checkout tips instantly.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <% if (user) { %>
      <section class="mb-5" id="profile-cta">
        <div class="card shadow-soft border-0">
          <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
              <p class="text-success fw-bold mb-1">Welcome back, <%= user.username %>!</p>
              <h5 class="mb-0">Keep your delivery details updated for a faster checkout.</h5>
            </div>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-success" href="/orders"><i class="bi bi-receipt"></i> Your orders</a>
              <a class="btn btn-success" href="/profile"><i class="bi bi-person-circle"></i> Profile</a>
            </div>
          </div>
        </div>
      </section>
    <% } %>
  </div>

  <!-- Chatbot -->
  <div class="chatbox bg-white" id="chatbox">
    <div class="chatbox-header">
      <div>
        <div class="fw-bold">Isaac's AI Helper</div>
        <small class="text-white-50">Need product tips or checkout help?</small>
      </div>
      <button class="btn btn-sm btn-light" onclick="toggleChat(false)"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-bubble bot">Hi! Ask me about products, delivery, payments, or your account.</div>
    </div>
    <form class="d-flex border-top p-2 gap-2 bg-white" id="chatForm">
      <input class="form-control form-control-sm" id="chatInput" placeholder="Type your question..." autocomplete="off">
      <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-send-fill"></i></button>
    </form>
  </div>

  <div class="assistant-toggle">
    <button class="btn btn-success rounded-circle p-3 shadow-lg" onclick="toggleChat()">
      <i class="bi bi-robot fs-5"></i>
    </button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const searchInput = document.getElementById('homeSearch');
    const productCards = Array.from(document.querySelectorAll('.product-card'));
    let activeCategory = 'all';

    function setCategory(category) {
      activeCategory = category;
      document.querySelectorAll('.category-chip').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === category);
      });
      filterFeatured();
    }

    function filterFeatured() {
      const query = (searchInput?.value || '').toLowerCase();
      let visible = 0;

      productCards.forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const category = card.dataset.category ? card.dataset.category.toLowerCase() : 'all';
        const matchesCategory = activeCategory === 'all' || category === activeCategory.toLowerCase();
        const matchesSearch = !query || name.includes(query);
        const isVisible = matchesCategory && matchesSearch;
        card.classList.toggle('d-none', !isVisible);
        if (isVisible) visible++;
      });

      if (visible === 0 && productCards.length > 0) {
        const grid = document.getElementById('featuredGrid');
        if (!document.getElementById('emptyState')) {
          const el = document.createElement('div');
          el.id = 'emptyState';
          el.className = 'col-12';
          el.innerHTML = '<div class="alert alert-warning mb-0">No matches found. Try a different keyword.</div>';
          grid.appendChild(el);
        }
      } else {
        const empty = document.getElementById('emptyState');
        if (empty) empty.remove();
      }
    }

    // Chatbot
    const chatbox = document.getElementById('chatbox');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    function toggleChat(forceHide) {
      const shouldHide = typeof forceHide === 'boolean' ? forceHide : chatbox.style.display === 'block';
      chatbox.style.display = shouldHide ? 'none' : 'block';
      if (!shouldHide) {
        setTimeout(() => chatInput.focus(), 100);
      }
    }

    function appendMessage(text, type = 'bot') {
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${type}`;
      bubble.textContent = text;
      chatMessages.appendChild(bubble);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      appendMessage(text, 'me');
      chatInput.value = '';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        appendMessage(data.reply || 'Let me find that for you.', 'bot');
      } catch (err) {
        appendMessage('Unable to reach the assistant right now.', 'bot');
      }
    });
  </script>
</body>
</html>
