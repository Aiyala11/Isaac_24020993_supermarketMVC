<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="/css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Analytics - Isaac's Supermarket</title>
  <style>
    body { background: #f6fbf6; font-family: 'Sora','Inter','Segoe UI',sans-serif; }
    .analytics-header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px 20px; margin-bottom: 30px; border-radius: 0; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
    .analytics-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .analytics-header p { font-size: 14px; opacity: 0.95; margin: 0; }
    .analytics-container { max-width: 1400px; margin: 0 auto; padding: 0 1rem 40px; }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-left: 4px solid #28a745; transition: transform 0.2s, box-shadow 0.2s; }
    .metric-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(40, 167, 69, 0.15); }
    .metric-number { font-size: 28px; font-weight: 700; color: #28a745; margin-bottom: 8px; }
    .metric-label { font-size: 13px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-icon { font-size: 20px; color: #28a745; opacity: 0.3; text-align: right; margin-top: -8px; }
    .chart-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .chart-title { font-size: 16px; font-weight: 700; color: #2d4737; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e8f1eb; }
    .chart-container { position: relative; height: 300px; margin-bottom: 20px; }
    .table-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .table-title { font-size: 16px; font-weight: 700; color: #2d4737; padding: 24px 24px 0; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e8f1eb; }
    .analytics-table { border-collapse: collapse; }
    .analytics-table thead { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: 600; }
    .analytics-table tbody tr { border-bottom: 1px solid #f0f0f0; transition: all 0.2s ease; }
    .analytics-table tbody tr:hover { background-color: #f8f9fa; }
    .analytics-table tbody td { padding: 16px 24px; }
    .analytics-table thead th { padding: 16px 24px; }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-critical { background-color: #f8d7da; color: #721c24; }
    .status-low { background-color: #fff3cd; color: #856404; }
    .status-good { background-color: #d4edda; color: #155724; }
    .back-btn { color: #28a745; text-decoration: none; font-weight: 600; margin-bottom: 20px; display: inline-block; }
    .back-btn:hover { text-decoration: underline; }
    .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    @media (max-width: 768px) { .metric-grid { grid-template-columns: repeat(2, 1fr); } .charts-row { grid-template-columns: 1fr; } .analytics-header h1 { font-size: 22px; } }
  </style>
</head>
<body>

  <%- include('partials/adminnavbar') %>

  <!-- ANALYTICS HEADER -->
  <div class="analytics-header">
    <div class="analytics-container">
      <a href="/admin" class="back-btn"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
      <h1><i class="bi bi-graph-up"></i> Sales & Inventory Analytics</h1>
      <p>Track your business performance and inventory insights</p>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="analytics-container">

    <!-- KEY METRICS -->
    <div class="metric-grid">
      <div class="metric-card">
        <div class="metric-number"><%= totalOrders %></div>
        <div class="metric-label">Total Orders</div>
        <div class="metric-icon"><i class="bi bi-receipt"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-number">$<%= averageOrderValue.toFixed(2) %></div>
        <div class="metric-label">Avg Order Value</div>
        <div class="metric-icon"><i class="bi bi-cash-coin"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-number">$<%= inventoryValue %></div>
        <div class="metric-label">Total Inventory Value</div>
        <div class="metric-icon"><i class="bi bi-boxes"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-number"><%= lowStockProducts.length %></div>
        <div class="metric-label">Low Stock Items</div>
        <div class="metric-icon"><i class="bi bi-exclamation-triangle"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-number"><%= products.length %></div>
        <div class="metric-label">Total Products</div>
        <div class="metric-icon"><i class="bi bi-box-seam"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-number"><%= orders.length %></div>
        <div class="metric-label">All Transactions</div>
        <div class="metric-icon"><i class="bi bi-graph-up"></i></div>
      </div>
    </div>

    <!-- CHARTS SECTION -->
    <div class="charts-row">
      <!-- Sales by Category Chart -->
      <div class="chart-section">
        <div class="chart-title"><i class="bi bi-pie-chart"></i> Sales by Category</div>
        <div class="chart-container">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <!-- Top Products Chart -->
      <div class="chart-section">
        <div class="chart-title"><i class="bi bi-bar-chart"></i> Top Selling Products</div>
        <div class="chart-container">
          <canvas id="topProductsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- TOP PRODUCTS TABLE -->
    <div class="table-section">
      <div class="table-title"><i class="bi bi-star-fill"></i> Top 5 Best Sellers</div>
      <% if (topProducts && topProducts.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover mb-0 analytics-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Units Sold</th>
                <th>Unit Price</th>
                <th>Total Revenue</th>
              </tr>
            </thead>
            <tbody>
              <% topProducts.forEach(p => { %>
                <tr>
                  <td><strong><%= p.productName %></strong></td>
                  <td><%= p.quantity %></td>
                  <td>$<%= p.price.toFixed(2) %></td>
                  <td><strong>$<%= (p.price * p.quantity).toFixed(2) %></strong></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div style="padding: 24px; text-align: center; color: #999;">
          <p>No sales data available yet</p>
        </div>
      <% } %>
    </div>

    <!-- LOW STOCK ALERT TABLE -->
    <div class="table-section">
      <div class="table-title"><i class="bi bi-exclamation-triangle-fill"></i> Low Stock Alert</div>
      <% if (lowStockProducts && lowStockProducts.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover mb-0 analytics-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Current Stock</th>
                <th>Price</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% lowStockProducts.forEach(p => { %>
                <tr>
                  <td><strong><%= p.productName %></strong></td>
                  <td><%= p.quantity %> units</td>
                  <td>$<%= Number(p.price).toFixed(2) %></td>
                  <td>
                    <% if (p.quantity === 0) { %>
                      <span class="status-badge status-critical">Out of Stock</span>
                    <% } else { %>
                      <span class="status-badge status-low">Low Stock</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div style="padding: 24px; text-align: center; color: #999;">
          <p><i class="bi bi-check-circle"></i> All products have healthy stock levels!</p>
        </div>
      <% } %>
    </div>

    <!-- SALES BY CATEGORY TABLE -->
    <div class="table-section">
      <div class="table-title"><i class="bi bi-tags-fill"></i> Sales by Category</div>
      <% if (salesByCategory && salesByCategory.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover mb-0 analytics-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Total Sales</th>
                <th>% of Total</th>
              </tr>
            </thead>
            <tbody>
              <% 
                const totalSales = salesByCategory.reduce((sum, cat) => sum + cat.sales, 0);
              %>
              <% salesByCategory.forEach(cat => { %>
                <tr>
                  <td><strong><%= cat.category %></strong></td>
                  <td>$<%= cat.sales.toFixed(2) %></td>
                  <td><%= ((cat.sales / totalSales) * 100).toFixed(1) %>%</td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div style="padding: 24px; text-align: center; color: #999;">
          <p>No category sales data available yet</p>
        </div>
      <% } %>
    </div>

  </div>

  <script>
    // Category Sales Chart
    <% if (salesByCategory && salesByCategory.length > 0) { %>
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: [<%= salesByCategory.map(c => `"${c.category}"`).join(',') %>],
          datasets: [{
            data: [<%= salesByCategory.map(c => c.sales).join(',') %>],
            backgroundColor: [
              '#28a745', '#20c997', '#0dcaf0', '#0dcaf0', '#198754',
              '#fd7e14', '#dc3545', '#6f42c1', '#e83e8c', '#ffc107'
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    <% } %>

    // Top Products Chart
    <% if (topProducts && topProducts.length > 0) { %>
      const topCtx = document.getElementById('topProductsChart').getContext('2d');
      const topChart = new Chart(topCtx, {
        type: 'bar',
        data: {
          labels: [<%= topProducts.map(p => `"${p.productName.substring(0, 15)}"`).join(',') %>],
          datasets: [{
            label: 'Units Sold',
            data: [<%= topProducts.map(p => p.quantity).join(',') %>],
            backgroundColor: '#28a745',
            borderColor: '#20c997',
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom' }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    <% } %>
  </script>

</body>
</html>
